# NixOS Hardware Detection System

## Overview

This document describes the hardware detection system for the pantherOS NixOS configuration, replacing the imperative CachyOS shell-based detection with declarative Nix modules.

## Architecture

### Components

1. **`lib/hardware-detection.nix`** – Utility functions for extracting hardware specs from facter JSON data
2. **`modules/hardware/asus-rog.nix`** – ASUS ROG laptop support (power management, tools)
3. **`modules/hardware/detection-scripts.nix`** – Runtime diagnostic scripts
4. **`hosts/zephyrus/hardware-facter.nix`** – Facter-driven hardware config for Zephyrus
5. **`hosts/zephyrus/zephyrus-facter.json`** – Hardware manifest (generated by nixos-facter)

### Data Flow

```
zephyrus-facter.json (hardware inventory)
           ↓
hardware-facter.nix (parses with hardware-detection.nix)
           ↓
NixOS configuration (enables CPU/GPU/storage features)
           ↓
System build with hardware-specific settings
           ↓
Runtime scripts (hardware-inventory, verify-hardware, power-status)
```

## Usage

### Build Configuration

```bash
# Build zephyrus configuration
nix build .#nixosConfigurations.zephyrus.config.system.build.toplevel

# Or with nixos-rebuild
nixos-rebuild build --flake .#zephyrus
```

### Hardware Detection

After system is built, run diagnostic scripts:

```bash
# Generate full hardware inventory
hardware-inventory > /tmp/hw-report.txt

# Verify critical components
verify-hardware /tmp/hw-report.txt

# Quick power/battery status
power-status
```

### View Hardware Summary

```bash
# View auto-generated hardware summary
cat /etc/hardware-summary.txt
```

## Features

### Automatic Detection

- **CPU**: Model, manufacturer, clock speeds (from facter)
- **GPU**: Display capability, count, vendors (from facter)
- **Memory**: Count, size, speed, type (from facter)
- **Storage**: All devices, NVMe count, models, capacities (from facter)
- **Network**: Device count and vendors (from facter)
- **ASUS ROG**: Platform detection, features (from facter + runtime checks)
- **Laptop**: Battery presence (from facter)
- **Hybrid GPU**: Intel iGPU + NVIDIA dGPU combo (from facter)

### Power Management (ASUS ROG)

When `hardware.asus.enable = true`:

- Enables `asusctl` (ASUS system control daemon)
- Enables `power-profiles-daemon` (AC/battery profile switching)
- Supports battery charge limit (default: 80%)
- Keyboard backlight control (if available)
- Udev rules for unprivileged hardware access

### Runtime Diagnostic Scripts

#### `hardware-inventory`

Comprehensive hardware report including:
- CPU specifications
- GPU information (from PCI)
- Memory modules
- Storage devices and NVMe details
- BTRFS configuration
- Power management status
- Battery information
- Network devices
- ASUS ROG platform detection
- Thermal zones
- Loaded kernel modules

#### `verify-hardware`

Validates critical hardware components:
- CPU detection ✓
- NVMe detection ✓
- ASUS WMI platform ✓
- Power management tools ✓
- BTRFS support ✓
- Battery detection ✓

#### `power-status`

Quick status report showing:
- Current power profile
- Available profiles
- Power supply status (AC/battery/capacity)
- ACPI information

## Configuration

### Enable/Disable ASUS ROG Features

In NixOS config:

```nix
hardware.asus = {
  enable = true;  # Auto-detected from facter
  asusc = true;   # ASUS control daemon
  powerProfiles = true;  # Profile switching
  enableBatteryThreshold = 80;  # Battery charge limit
  enableKeyboardBacklight = true;
};
```

### Customize Hardware Detection

Edit `hosts/zephyrus/hardware-facter.nix`:

```nix
# Override CPU microcode
hardware.cpu.amd.updateMicrocode = true;

# Customize GPU driver
hardware.nvidia.open = false;  # Use proprietary driver

# Add/remove kernel modules
boot.kernelModules = [ "custom_module" ];
```

## Data Sources

### Facter JSON Structure

The `zephyrus-facter.json` file is generated by [nixos-facter](https://github.com/nix-community/nixos-facter-modules) and contains:

```json
{
  "version": 1,
  "system": "x86_64-linux",
  "virtualization": "none",
  "hardware": {
    "bios": { ... },
    "processor": [ ... ],
    "disk": [ ... ],
    "memory": [ ... ],
    "display": [ ... ],
    "network": [ ... ],
    ...
  }
}
```

### Updating Facter Data

If hardware changes (SSD upgrade, memory addition), regenerate facter:

```bash
# Boot into NixOS installer or running system
nix run github:nix-community/nixos-facter -- --output ./hosts/zephyrus/zephyrus-facter.json
```

## Known Limitations

1. **ASUS ROG Hardware Module**: No official NixOS module exists for all ASUS ROG features. This config wraps `asusctl` in a systemd service. Some features may require manual udev rules or kernel module tweaks.

2. **Hybrid GPU**: Detection works for Intel iGPU + NVIDIA combo, but driver configuration may need manual tuning based on your specific dGPU model.

3. **Battery Threshold**: Requires kernel module support (`asus_nb_wmi`) and may not work on all ROG models. Fallback to manual sysfs writes.

4. **Facter Accuracy**: Depends on accurate SMBIOS data from BIOS. Some systems may have incorrect/incomplete hardware reporting.

## Troubleshooting

### ASUS WMI not detected

```bash
# Check if kernel module is loaded
lsmod | grep asus

# Load manually if needed
sudo modprobe asus_nb_wmi
sudo modprobe asus_wmi

# Check sysfs
ls -la /sys/devices/platform/asus-nb-wmi/
```

### asusctl daemon fails to start

```bash
# Check systemd service
systemctl status asusctl

# View logs
journalctl -u asusctl -e

# Try manual execution
asusctl --info
```

### Hardware detection returns empty

```bash
# Check facter data
cat hosts/zephyrus/zephyrus-facter.json | jq .hardware

# Regenerate facter data
nix run github:nix-community/nixos-facter
```

### Power profiles not switching

```bash
# Check power-profiles-daemon
systemctl status power-profiles-daemon

# View available profiles
powerprofilesctl list

# Check daemon logs
journalctl -u power-profiles-daemon -e
```

## Integration with Other Modules

- **Power Management**: Used by `home/modules/power-management/` for user-level profile switching
- **Shell Environment**: Hardware info available in `$HW_*` environment variables (future)
- **Desktop Environment**: GPU detection used by Niri/DMS theming
- **Storage Optimization**: NVMe detection triggers TRIM/scheduler settings

## References

- [NixOS Hardware Modules](https://github.com/nix-community/nixos-hardware)
- [nixos-facter](https://github.com/nix-community/nixos-facter-modules)
- [ASUS Hardware Support (Arch Wiki)](https://wiki.archlinux.org/title/ASUS_ROG_utilities)
- [NixOS Boot Options Manual](https://nixos.org/manual/nixos/stable/#ch-booting)

## Next Steps

1. ✅ Hardware detection infrastructure implemented
2. ⏳ Power management module (battery/AC profile switching) – **Prompt 2**
3. ⏳ Storage optimization (TRIM, I/O schedulers) – **Prompt 3**
4. ⏳ Shell environment (Fish, Fisher, plugins) – **Prompt 4**
5. ⏳ Security and 1Password integration – **Prompt 5**
6. ⏳ Desktop environment (Niri, DMS, theming) – **Prompt 6**
