# Host Configuration Guide

This guide explains how to configure individual hosts in pantherOS.

## Overview

Each host has:
- Specific purpose and optimizations
- Hardware-specific configuration
- Unique service requirements
- Custom module组合

## Host Architecture

### Workstation Hosts
- **yoga**: Lightweight, battery-optimized
- **zephyrus**: High-performance, feature-rich

### Server Hosts
- **hetzner-vps**: Primary server (codespace)
- **ovh-vps**: Secondary server (backup)

## Configuration Files

Each host has three key files:

```
hosts/<hostname>/
├── disko.nix        # Disk layout (Disko)
├── hardware.nix     # Hardware configuration
└── default.nix      # Main configuration
```

### disko.nix
Defines disk layout using Disko:
- Btrfs filesystem
- Sub-volume structure
- Mount points
- SSD optimizations

### hardware.nix
Hardware-specific settings:
- Hardware detection
- Driver configuration
- Kernel parameters
- Firmware requirements

### default.nix
Main host configuration:
- Module imports
- Service definitions
- User configuration
- System settings

## Configuring a New Host

### Step 1: Hardware Discovery

Follow the [Hardware Discovery Guide](./hardware-discovery.md):
- Scan hardware specifications
- Document in `docs/hardware/<hostname>.md`
- Plan disk layout

### Step 2: Create Host Directory

```bash
mkdir -p hosts/<hostname>
```

### Step 3: Create disko.nix

Example Btrfs layout:
```nix
{ lib, ... }:

{
  disko.devices = {
    disk = {
      main = {
        type = "disk";
        device = "/dev/nvme0n1";
        content = {
          type = "gpt";
          partitions = {
            boot = {
              size = "512M";
              type = "EF00";
              content = {
                type = "filesystem";
                fsType = "vfat";
                mountPoint = "/boot";
              };
            };
            root = {
              size = "100%";
              type = "8304";
              content = {
                type = "btrfs";
                subvolumes = {
                  "/" = {
                    mountPoint = "/";
                    mountOptions = [ "compress=zstd" "noatime" ];
                  };
                  "/home" = {
                    mountPoint = "/home";
                    mountOptions = [ "compress=zstd" "noatime" ];
                  };
                  "/dev" = {
                    mountPoint = "/dev";
                    mountOptions = [ "compress=zstd" "noatime" ];
                  };
                  "/var" = {
                    mountPoint = "/var";
                    mountOptions = [ "compress=zstd" "noatime" ];
                  };
                  "/nix" = {
                    mountPoint = "/nix";
                    mountOptions = [ "compress=zstd" "noatime" ];
                  };
                  "/snapshots" = {
                    mountPoint = "/.snapshots";
                    mountOptions = [ "compress=zstd" "noatime" ];
                  };
                };
              };
            };
          };
        };
      };
    };
  };
}
```

### Step 4: Create hardware.nix

Generated by `nixos-generate-config`:
```bash
nixos-generate-config --show-hardware-config > hosts/<hostname>/hardware.nix
```

Review and adjust as needed:
- Remove unnecessary hardware detection
- Add missing drivers
- Configure kernel parameters

### Step 5: Create default.nix

Main configuration file:
```nix
{ inputs, lib, pkgs, ... }:

{
  imports = [
    # Hardware and disk
    ./hardware.nix
    ./disko.nix

    # System modules
    inputs.nixos-modules.nixos.core
    inputs.nixos-modules.nixos.services

    # Security
    inputs.nixos-modules.nixos.security

    # Hardware-specific
    inputs.nixos-modules.nixos.hardware.<hostname>

    # Shared modules
    inputs.nixos-modules.shared.base
  ];

  # Host identification
  networking.hostName = "<hostname>";
  systemd.hostName = "<hostname>";

  # Time zone
  time.timeZone = "America/New_York";

  # Users
  users.users.hbohlen = {
    isNormalUser = true;
    extraGroups = [ "wheel" "networkmanager" "docker" ];
  };

  # System configuration
  services.openssh.enable = true;
  networking.networkmanager.enable = true;

  # Enable all modules
  programs.module1.enable = true;
  programs.module2.enable = true;

  # Host-specific settings
  <hostname> = {
    optimization = "battery";  # or "performance"
    useCase = "workstation";   # or "server"
  };
}
```

### Step 6: Add to flake.nix

Update `flake.nix` to include the new host:
```nix
{
  outputs = { self, nixpkgs, ... }: {
    nixosConfigurations = {
      <hostname> = nixpkgs.lib.nixosSystem {
        system = "x86_64-linux";
        modules = [
          ./hosts/<hostname>
          # ... other modules
        ];
      };
    };
  };
}
```

Update flake and test build:
```bash
nix flake update
nixos-rebuild build .#<hostname>
```

## Host-Specific Optimizations

### Yoga (Lightweight Workstation)

Priorities: Battery life, lightweight operation

```nix
# In default.nix
{ ... }:

{
  # Power management
  powerManagement.cpuFreqGovernor = "powersave";
  services.tlp.enable = true;

  # Lightweight applications
  programs.workstation = {
    enable = true;
    profile = "lightweight";
  };

  # Battery optimization
  hardware.battery.enable = true;
}
```

### Zephyrus (High-Performance Workstation)

Priorities: Performance, multiple power profiles

```nix
# In default.nix
{ ... }:

{
  # Power profiles
  programs.power-profiles-daemon.enable = true;

  # GPU optimization
  hardware.nvidia = {
    powerManagement.enable = true;
    prime = {
      offload.enable = true;
      reverseSync.enable = true;
    };
  };

  # Podman optimization
  virtualisation.podman.enable = true;
  virtualisation.podman.dockerCompat = true;

  # High-performance profile
  programs.workstation = {
    enable = true;
    profile = "performance";
  };
}
```

### Hetzner VPS (Primary Server)

Priorities: Server services, codespace

```nix
# In default.nix
{ ... }:

{
  # Server configuration
  services.server = {
    enable = true;
    role = "primary";
    services = [ "codespace" "proxy" ];
  };

  # Tailscale
  services.tailscale.enable = true;

  # Reverse proxy
  services.caddy.enable = true;

  # Container hosting
  virtualisation.podman.enable = true;

  # Security hardening
  security.firewall = {
    enable = true;
    allowSSH = true;
    allowTailnet = true;
  };
}
```

### OVH VPS (Secondary Server)

Priorities: Same as Hetzner, backup

```nix
# In default.nix
{ ... }:

{
  # Mirror Hetzner configuration
  imports = [ ./servers/hetzner-vps ];

  services.server = {
    enable = true;
    role = "secondary";
  };
}
```

## Configuration Management

### Testing Configuration

Always test before deploying:

```bash
# Build test (compilation only)
nixos-rebuild build .#<hostname>

# Dry run (test activation)
nixos-rebuild dry-activate --flake .#<hostname>
```

### Deploying Changes

**CAUTION**: Use switch carefully on remote systems!

For workstations (local):
```bash
nixos-rebuild switch --flake .#<hostname>
```

For servers (remote):
```bash
# From another machine with Tailscale
nixos-rebuild switch --flake .#<hostname> --use-remote-sudo

# Or SSH directly
ssh <hostname>
sudo nixos-rebuild switch --flake .#<hostname>
```

### Rollback

If something goes wrong:

```bash
# List previous generations
nixos-rebuild list-generations

# Rollback to previous generation
sudo nixos-rebuild switch --generation <number>

# Or from GRUB menu
# Select "Previous configuration" during boot
```

## Host Maintenance

### Update Configuration

```bash
# Edit configuration
vim hosts/<hostname>/default.nix

# Test build
nixos-rebuild build .#<hostname>

# Deploy
nixos-rebuild switch --flake .#<hostname>
```

### Update System

```bash
# Update flake inputs
nix flake update

# Build with updates
nixos-rebuild build .#<hostname>

# Deploy
nixos-rebuild switch --flake .#<hostname>
```

### View Configuration

```bash
# Show current configuration
nixos-rebuild show-config --flake .#<hostname>
```

## Troubleshooting

### Build Fails

1. Check error message:
```bash
nixos-rebuild build .#<hostname> 2>&1 | tee build-log.txt
```

2. Check hardware.nix is correct
3. Verify all modules are imported
4. Check for syntax errors

### Host Not Booting

1. Use previous generation from GRUB
2. Access via Tailscale from another machine
3. For VPS, use web console
4. Check logs: `journalctl -b -1`

### Services Not Starting

1. Check service status:
```bash
systemctl status <service>
```

2. View logs:
```bash
journalctl -u <service> -f
```

3. Check configuration:
```bash
nixos-rebuild dry-activate --flake .#<hostname>
```

### Configuration Drift

If configuration changes aren't applied:

1. Force rebuild:
```bash
nixos-rebuild switch --flake .#<hostname> --upgrade
```

2. Clear build cache:
```bash
rm -rf /nix/store/*-nixos-<hash>*
```

---

**See also:**
- [Hardware Discovery](./hardware-discovery.md)
- [Module Development](./module-development.md)
- [Testing and Deployment](./testing-deployment.md)
- [Phase 3 Tasks](../todos/phase3-host-configuration.md)
